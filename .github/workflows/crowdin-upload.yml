name: Upload Sources to Crowdin

on:
  # Manual trigger for full control
  workflow_dispatch:
    inputs:
      force_upload:
        description: 'Force upload even if no changes detected'
        required: false
        default: false
        type: boolean

  # Automatic trigger when translation files are modified
  push:
    branches: [main, develop]
    paths:
      - '*/languages/*.pot'

permissions:
  contents: read

jobs:
  upload:
    name: Upload Source Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need to check for changes

      - name: Check for relevant changes
        id: changes
        if: github.event_name == 'push'
        run: |
          # Check if any translation-related files changed
          if git diff --name-only HEAD~1 HEAD | grep -E '${{ github.event.repository.name }}/languages/.*\.pot$' > /dev/null; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "✅ Translation-related files detected"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "❌ No translation-related changes detected"
          fi

      - name: Skip upload if no changes
        if: github.event_name == 'push' && steps.changes.outputs.changes_detected == 'false'
        run: |
          echo "❌ Skipping Crowdin upload - no relevant changes detected"
          exit 0

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          mariadb_tag: latest
          wordpress_tag: latest
          node_tag: 22
          plugin_name: ${{ github.event.repository.name }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          crowdin_project_id: ${{ secrets.CROWDIN_PROJECT_ID }}
          crowdin_personal_token: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Upload sources to Crowdin
        run: make crowdin-upload

      - name: Shutdown environment
        uses: ./.github/actions/shutdown
        with:
          cleanup_mode: basic
